---
- name: Create a virtual machine from a VMOrder
  hosts: localhost
  gather_facts: false

  vars:
    vm_order: "{{ ansible_eda.event.payload }}"
    vm_order_name: "{{ ansible_eda.event.payload.metadata.name }}"

  pre_tasks:
    - name: Show EDA Event
      ansible.builtin.debug:
        var: ansible_eda.event.payload

    # Brings in variables:
    # template_id, template_parameters
    - name: Extract VM template info
      ansible.builtin.include_role:
        name: cloudkit.service.extract_vm_template_info

    # Brings in variables:
    # vm_working_namespace
    - name: Determine working namespace
      ansible.builtin.include_role:
        name: cloudkit.service.vm_working_namespace

  tasks:

    - name: Display VM order information
      ansible.builtin.debug:
        msg:
          - "VM order name: {{ vm_order_name }}"
          - "VM working namespace: {{ vm_working_namespace }}"
          - "Template ID: {{ template_id }}"
          - "Template parameters: {{ template_parameters }}"

    - name: "Set the finalizer on the Cloudkit VM {{ vm_order_name }}"
      ansible.builtin.include_role:
        name: cloudkit.service.finalizer
      vars:
        finalizer_state: present
        finalizer_name: "{{ vm_cloudkit_finalizer }}"
        finalizer_target:
          api_version: cloudkit.openshift.io/v1alpha1
          kind: VirtualMachine
          namespace: "{{ vm_order.metadata.namespace }}"
          name: "{{ vm_order_name }}"

    - name: Call the selected VM template
      ansible.builtin.include_role:
        name: "{{ template_id }}"
        tasks_from: "create"
