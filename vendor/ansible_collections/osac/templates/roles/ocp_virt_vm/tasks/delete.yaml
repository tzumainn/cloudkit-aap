- name: Get VirtualMachine info for floating IP cleanup
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_order_name }}"
    namespace: "{{ vm_working_namespace }}"
  register: vm_info

- name: Check if VM instance exists
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachineInstance
    name: "{{ vm_order_name }}"
    namespace: "{{ vm_working_namespace }}"
  register: vm_exists

- name: Stop VirtualMachine
  kubernetes.core.k8s:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_order_name }}"
    namespace: "{{ vm_working_namespace }}"
    state: present
    definition:
      spec:
        running: false
  when: vm_exists.resources

- name: Wait for VM to stop
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_order_name }}"
    namespace: "{{ vm_working_namespace }}"
    wait: true
    wait_condition:
      type: Ready
      status: "False"
    wait_timeout: 300
  when: vm_exists.resources

- name: Delete VirtualMachine
  kubernetes.core.k8s:
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ vm_order_name }}"
    namespace: "{{ vm_working_namespace }}"
    state: absent
    wait: true
    wait_timeout: 300

- name: Delete VM service (if it exists)
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: "{{ vm_order_name }}-service"
    namespace: "{{ vm_working_namespace }}"
    state: absent

- name: Delete VM load balancer service
  kubernetes.core.k8s:
    api_version: v1
    kind: Service
    name: "{{ vm_order_name }}-load-balancer"
    namespace: "{{ vm_working_namespace }}"
    state: absent

- name: Delete root disk DataVolume
  kubernetes.core.k8s:
    api_version: cdi.kubevirt.io/v1beta1
    kind: DataVolume
    name: "{{ vm_order_name }}-root-disk"
    namespace: "{{ vm_working_namespace }}"
    state: absent
    wait: true
    wait_timeout: 300

- name: Delete cloud-init secret
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    name: "{{ vm_order_name }}-cloud-init"
    namespace: "{{ vm_working_namespace }}"
    state: absent
  register: delete_cloud_init_secret
  failed_when:
    - delete_cloud_init_secret.failed is defined
    - delete_cloud_init_secret.failed
    - "'not found' not in (delete_cloud_init_secret.msg | default(''))"

- name: Delete ssh public key secret
  kubernetes.core.k8s:
    api_version: v1
    kind: Secret
    name: "{{ vm_order_name }}-ssh-public-key"
    namespace: "{{ vm_working_namespace }}"
    state: absent
  register: delete_ssh_secret
  failed_when:
    - delete_ssh_secret.failed is defined
    - delete_ssh_secret.failed
    - "'not found' not in (delete_ssh_secret.msg | default(''))"

- name: Display deletion status
  ansible.builtin.debug:
    msg:
      - "Virtual Machine '{{ vm_order_name }}' deletion completed"
      - "Namespace: {{ vm_working_namespace }}"
      - "All associated resources have been removed"
