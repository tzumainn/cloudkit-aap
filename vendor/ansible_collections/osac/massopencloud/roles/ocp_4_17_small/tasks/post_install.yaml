---
- name: Ensure openshift-operators namespace exists
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: openshift-operators

- name: Create cert-manager subscription
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1alpha1
      kind: Subscription
      metadata:
        name: cert-manager
        namespace: openshift-operators
      spec:
        channel: stable
        installPlanApproval: Automatic
        name: cert-manager
        source: community-operators
        sourceNamespace: openshift-marketplace

- name: Create production issuer
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-production-http01
      spec:
        acme:
          privateKeySecretRef:
            name: letsencrypt-production-http01
          server: 'https://acme-v02.api.letsencrypt.org/directory'
          solvers:
            - http01:
                ingress:
                  class: openshift-default
  register: production_issuer_result
  until: production_issuer_result is succeeded
  retries: 30
  delay: 30

- name: Create staging issuer
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-staging-http01
      spec:
        acme:
          privateKeySecretRef:
            name: letsencrypt-staging-http01
          server: 'https://acme-staging-v02.api.letsencrypt.org/directory'
          solvers:
            - http01:
                ingress:
                  class: openshift-default
  register: staging_issuer_result
  until: staging_issuer_result is succeeded
  retries: 30
  delay: 30
